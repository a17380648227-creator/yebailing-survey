<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡ç™¾çµé—®å·æ•°æ®ç®¡ç†åå°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2d3748;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #718096;
            font-size: 14px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px 30px;
            background: #f7fafc;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 14px;
            color: #718096;
            font-weight: 600;
        }

        .controls {
            background: white;
            padding: 20px 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            border-top: 1px solid #e2e8f0;
        }

        select, button {
            padding: 10px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button.danger {
            background: linear-gradient(135deg, #fc5c7d 0%, #6a82fb 100%);
        }

        .table-container {
            background: white;
            padding: 30px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        thead {
            background: #f7fafc;
        }

        th {
            padding: 15px;
            text-align: left;
            font-size: 13px;
            color: #4a5568;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
            color: #2d3748;
        }

        tbody tr:hover {
            background: #f7fafc;
        }

        .rating {
            color: #f59e0b;
            font-weight: 700;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state img {
            width: 120px;
            opacity: 0.5;
            margin-bottom: 20px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            background: #e2e8f0;
            color: #4a5568;
        }

        .improvements {
            font-size: 12px;
            color: #718096;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-warning {
            background: #fef5e7;
            color: #7c5c00;
            border: 2px solid #f9e79f;
        }

        @media (max-width: 768px) {
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            select, button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ¾ é‡ç™¾çµé—®å·æ•°æ®ç®¡ç†åå°</h1>
            <p class="subtitle">å®æ—¶æŸ¥çœ‹å„é—¨åº—é¡¾å®¢åé¦ˆæ•°æ®</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="number" id="totalCount">0</div>
                <div class="label">æ€»é—®å·æ•°</div>
            </div>
            <div class="stat-card">
                <div class="number" id="storeCount">0</div>
                <div class="label">é—¨åº—æ•°</div>
            </div>
            <div class="stat-card">
                <div class="number" id="avgRating">0.0</div>
                <div class="label">å¹³å‡è¯„åˆ†</div>
            </div>
            <div class="stat-card">
                <div class="number" id="todayCount">0</div>
                <div class="label">ä»Šæ—¥é—®å·</div>
            </div>
        </div>

        <div class="controls">
            <select id="storeFilter">
                <option value="">å…¨éƒ¨é—¨åº—</option>
            </select>
            <select id="tableFilter">
                <option value="">å…¨éƒ¨æ¡Œå·</option>
            </select>
            <button onclick="exportToCSV()">ğŸ“Š å¯¼å‡ºExcel</button>
            <button onclick="exportToJSON()">ğŸ’¾ å¯¼å‡ºJSON</button>
            <button class="danger" onclick="clearData()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
            <button onclick="location.reload()">ğŸ”„ åˆ·æ–°</button>
        </div>

        <div class="table-container">
            <div id="alertContainer"></div>
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>åºå·</th>
                        <th>é—¨åº—</th>
                        <th>æ¡Œå·</th>
                        <th>åŒä¼´</th>
                        <th>è¯„åˆ†</th>
                        <th>å¾…æ”¹è¿›</th>
                        <th>å»ºè®®</th>
                        <th>æäº¤æ—¶é—´</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- æ•°æ®ä¼šé€šè¿‡JavaScriptå¡«å…… -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];

        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        window.addEventListener('load', () => {
            loadData();
            updateStats();
            renderTable();
            populateFilters();
        });

        // ä»localStorageåŠ è½½æ•°æ®
        function loadData() {
            try {
                const data = localStorage.getItem('yebailing_surveys');
                allData = data ? JSON.parse(data) : [];
                filteredData = [...allData];
                console.log('åŠ è½½äº†', allData.length, 'ä»½é—®å·æ•°æ®');
            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                allData = [];
                filteredData = [];
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            // æ€»é—®å·æ•°
            document.getElementById('totalCount').textContent = allData.length;

            // é—¨åº—æ•°
            const stores = new Set(allData.map(d => d.store));
            document.getElementById('storeCount').textContent = stores.size;

            // å¹³å‡è¯„åˆ†
            const ratings = allData.map(d => d.rating).filter(r => r > 0);
            const avgRating = ratings.length > 0
                ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1)
                : '0.0';
            document.getElementById('avgRating').textContent = avgRating;

            // ä»Šæ—¥é—®å·
            const today = new Date().toLocaleDateString('zh-CN');
            const todayCount = allData.filter(d => {
                const date = new Date(d.timestamp).toLocaleDateString('zh-CN');
                return date === today;
            }).length;
            document.getElementById('todayCount').textContent = todayCount;
        }

        // å¡«å……ç­›é€‰å™¨
        function populateFilters() {
            // é—¨åº—ç­›é€‰å™¨
            const stores = [...new Set(allData.map(d => d.store))].sort();
            const storeFilter = document.getElementById('storeFilter');
            storeFilter.innerHTML = '<option value="">å…¨éƒ¨é—¨åº—</option>';
            stores.forEach(store => {
                const option = document.createElement('option');
                option.value = store;
                option.textContent = store;
                storeFilter.appendChild(option);
            });

            // æ¡Œå·ç­›é€‰å™¨
            const tables = [...new Set(allData.map(d => d.table))].sort((a, b) => {
                return parseInt(a) - parseInt(b);
            });
            const tableFilter = document.getElementById('tableFilter');
            tableFilter.innerHTML = '<option value="">å…¨éƒ¨æ¡Œå·</option>';
            tables.forEach(table => {
                const option = document.createElement('option');
                option.value = table;
                option.textContent = table + 'å·æ¡Œ';
                tableFilter.appendChild(option);
            });

            // æ·»åŠ ç­›é€‰äº‹ä»¶
            storeFilter.addEventListener('change', applyFilters);
            tableFilter.addEventListener('change', applyFilters);
        }

        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            const storeValue = document.getElementById('storeFilter').value;
            const tableValue = document.getElementById('tableFilter').value;

            filteredData = allData.filter(item => {
                const storeMatch = !storeValue || item.store === storeValue;
                const tableMatch = !tableValue || item.table === tableValue;
                return storeMatch && tableMatch;
            });

            renderTable();
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const alertContainer = document.getElementById('alertContainer');

            if (filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <p style="font-size: 48px;">ğŸ“­</p>
                            <h3>æš‚æ— æ•°æ®</h3>
                            <p>è¿˜æ²¡æœ‰æ”¶åˆ°ä»»ä½•é—®å·åé¦ˆ</p>
                        </td>
                    </tr>
                `;

                if (allData.length === 0) {
                    alertContainer.innerHTML = `
                        <div class="alert alert-warning">
                            âš ï¸ <strong>æç¤ºï¼š</strong>å½“å‰æ²¡æœ‰ä»»ä½•é—®å·æ•°æ®ã€‚è¯·ç¡®ä¿ï¼š<br>
                            1. å·²ç»æœ‰ç”¨æˆ·é€šè¿‡äºŒç»´ç æ‰«ç å¡«å†™äº†é—®å·<br>
                            2. æ­¤ç®¡ç†é¡µé¢ä¸é—®å·é¡µé¢åœ¨åŒä¸€åŸŸåä¸‹è®¿é—®ï¼ˆéƒ½é€šè¿‡localhost:8888è®¿é—®ï¼‰
                        </div>
                    `;
                }
                return;
            }

            alertContainer.innerHTML = '';

            // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            const sortedData = [...filteredData].reverse();

            tbody.innerHTML = sortedData.map((item, index) => {
                const improvements = Array.isArray(item.improvements) && item.improvements.length > 0
                    ? item.improvements.join('ã€')
                    : 'æ— ';

                return `
                    <tr>
                        <td>${filteredData.length - index}</td>
                        <td><span class="badge">${item.store}</span></td>
                        <td><strong>${item.table}å·æ¡Œ</strong></td>
                        <td>${item.companion || '-'}</td>
                        <td class="rating">${'â˜…'.repeat(item.rating)}${'â˜†'.repeat(5 - item.rating)} (${item.rating})</td>
                        <td class="improvements">${improvements}</td>
                        <td>${item.suggestions || '-'}</td>
                        <td>${item.date}</td>
                    </tr>
                `;
            }).join('');
        }

        // å¯¼å‡ºä¸ºCSV
        function exportToCSV() {
            if (allData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡ºï¼');
                return;
            }

            const headers = ['åºå·', 'é—¨åº—', 'æ¡Œå·', 'åŒä¼´', 'è¯„åˆ†', 'å¾…æ”¹è¿›é¡¹', 'å»ºè®®', 'æäº¤æ—¶é—´'];
            const rows = allData.map((item, index) => {
                const improvements = Array.isArray(item.improvements)
                    ? item.improvements.join('ã€')
                    : '';
                return [
                    index + 1,
                    item.store,
                    item.table,
                    item.companion || '',
                    item.rating,
                    improvements,
                    item.suggestions || '',
                    item.date
                ];
            });

            // æ·»åŠ BOMä»¥æ”¯æŒExcelæ‰“å¼€ä¸­æ–‡
            let csv = '\uFEFF';
            csv += headers.join(',') + '\n';
            csv += rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `é‡ç™¾çµé—®å·æ•°æ®_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }

        // å¯¼å‡ºä¸ºJSON
        function exportToJSON() {
            if (allData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡ºï¼');
                return;
            }

            const json = JSON.stringify(allData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `é‡ç™¾çµé—®å·æ•°æ®_${new Date().toLocaleDateString()}.json`;
            link.click();
        }

        // æ¸…ç©ºæ•°æ®
        function clearData() {
            if (allData.length === 0) {
                alert('å·²ç»æ²¡æœ‰æ•°æ®äº†ï¼');
                return;
            }

            if (!confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ ${allData.length} ä»½é—®å·æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            if (!confirm('å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                return;
            }

            localStorage.removeItem('yebailing_surveys');
            alert('âœ… æ•°æ®å·²æ¸…ç©ºï¼');
            location.reload();
        }
    </script>
</body>
</html>
